<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>One File Web Chat</title>
    <link rel="stylesheet" href="https://unpkg.com/primeicons@7.0.0/primeicons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/primevue@4.0.0-rc.2/umd/primevue.min.js"></script>
    <script src="https://unpkg.com/@primevue/themes@4.0.0-rc.2/umd/lara.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.6.1/github-markdown.min.css">
    <style>
        .markdown-body {
            box-sizing: border-box;
            min-width: 100px;
            max-width: 980px;
            margin: 0px 0px 0px;
            padding: 15px;
        }

        .app-dark .markdown-body {
            /* Inverted colors for dark mode */
            background-color: #18181B;
            /* or another dark color */
            color: white;
            /* or another light color */
        }
    </style>
</head>

<body class="bg-gray-100">

    <div id="app">
        <p class="text-xl font-bold text-center px-4 py-2">
            App
        </p>
        <p-tabs :value="activeTab">
            <p-tablist>
                <p-tab v-for="(c,i) in TABS" :value="`${c}`">{{c}}</p-tab>
            </p-tablist>
            <p-tabpanels>
                <p-tabpanel value="Register">
                    <div class="mt-5">
                        <h2 class="text-xl font-bold">Register</h2>
                        <form @submit.prevent="api.registerUser">
                            <p-inputtext v-model="registerForm.username" placeholder="Username" type="text" required
                                class="border p-2 rounded w-full mb-2"></p-inputtext>
                            <p-inputtext v-model="registerForm.full_name" placeholder="Full Name" type="text" required
                                class="border p-2 rounded w-full mb-2"></p-inputtext>
                            <p-inputtext v-model="registerForm.email" placeholder="Email" type="email" required
                                class="border p-2 rounded w-full mb-2"></p-inputtext>
                            <p-inputtext v-model="registerForm.password" placeholder="Password" type="password" required
                                class="border p-2 rounded w-full mb-2"></p-inputtext>
                            <p-inputtext v-model="registerForm.invite" placeholder="Invite code" type="invite" required
                                class="border p-2 rounded w-full mb-2"></p-inputtext>
                            <p-button @click="()=>api.registerUser(registerForm)" type="submit"
                                class="bg-blue-500 text-white px-4 py-2 rounded w-full">Register</p-button>
                        </form>
                    </div>
                </p-tabpanel>

                <p-tabpanel value="Login">
                    <div>
                        <h2 class="text-xl font-bold mb-4">Login</h2>
                        <form @submit.prevent="loginUser">
                            <p-inputtext v-model="loginForm.username" placeholder="Email" type="text" required
                                class="border p-2 rounded w-full mb-2"></p-inputtext>

                            <p-inputtext v-if="!useOtp" v-model="loginForm.password" placeholder="Password"
                                :type="passwordVisible ? 'text' : 'password'" required
                                class="border p-2 rounded w-full mb-2"></p-inputtext>

                            <p-inputtext v-if="useOtp" v-model="loginForm.otp" placeholder="OTP" type="number" required
                                class="border p-2 rounded w-full mb-2"></p-inputtext>

                            
                                <p-button
                                icon="pi pi-eye"
                                class="absolute right-4 top-10"
                                @click="togglePasswordVisibility"
                            ></p-button>
                            <p-toggleswitch v-model="useOtp" label="Login with OTP"></p-toggleswitch>
                            <span class="font-medium">Login with OTP</span>
                            
                            <p-button type="submit" :disabled="loading"
                                class="bg-blue-500 text-white px-4 py-2 rounded w-full">
                                <span v-if="loading" class="pi pi-spinner animate-spin"></span>
                                <span v-else>Login</span>
                            </p-button>

                            <p class="text-center mt-4">Don't have an account?
                                <a href="/" class="text-blue-500 underline">Register here</a>
                            </p>
                        </form>
                    </div>
                </p-tabpanel>

                <p-tabpanel value="Profile">
                </p-tabpanel>

            </p-tabpanels>
        </p-tabs>

</body>

<script>

    class APIClient {
        constructor(baseURL = '') {
            this.baseURL = baseURL;
            this.authToken = null;
        }

        // Helper to set authentication token
        setAuthToken(token) {
            this.authToken = token;
        }

        // Helper for headers
        getHeaders(isJSON = true) {
            const headers = {};
            if (isJSON) headers["Content-Type"] = "application/json";
            if (this.authToken) headers["Authorization"] = `Bearer ${this.authToken}`;
            return headers;
        }

        // Helper for making requests
        async request(endpoint, method = "GET", body = null, isJSON = true) {
            const options = {
                method,
                headers: this.getHeaders(isJSON),
            };
            if (body) {
                options.body = isJSON ? JSON.stringify(body) : body;
            }
            const response = await fetch(`${this.baseURL}${endpoint}`, options);
            if (!response.ok) {
                const error = await response.json().catch(() => ({ message: "Unknown error" }));
                throw new Error(error.detail || error.message || "Request failed");
            }
            return response.json();
        }

        // Register User
        async registerUser(data) {
            return this.request("/register", "POST", data);
        }

        // Get Token (Login)
        async getToken(email, password) {
            const formData = new URLSearchParams();
            formData.append("username", email);
            formData.append("password", password);
            const response = await this.request("/token", "POST", formData, false);
            this.setAuthToken(response.access_token); // Save token for future requests
            return response;
        }

        // Edit User Info
        async editUserInfo(data) {
            return this.request("/edit", "POST", data);
        }

        // Remove Account
        async removeAccount(data) {
            return this.request("/remove", "POST", data);
        }

        // Get Current User Info
        async getCurrentUser() {
            return this.request("/me");
        }

        // Read Session
        async readSession() {
            return this.request("/session");
        }

        // Get OTP QR Code
        async getOtpQr() {
            const response = await fetch(`${this.baseURL}/otp/qr`, {
                headers: this.getHeaders(),
            });
            if (!response.ok) throw new Error("Failed to fetch OTP QR code");
            return response.blob();
        }

        // Get Login QR Code
        async getLoginQr(uid = null) {
            const endpoint = uid ? `/qr/${uid}` : "/qr";
            const response = await fetch(`${this.baseURL}${endpoint}`, {
                headers: this.getHeaders(),
            });
            if (!response.ok) throw new Error("Failed to fetch Login QR code");
            return response.blob();
        }

        // Login with QR Code
        async loginWithQr(uid) {
            return this.request(`/qr/login/${uid}`, "GET");
        }

        // Get OTP Token
        async getOtpToken(email, code) {
            return this.request(`/otp/login/${email}/${code}`, "GET");
        }

        // Read Icon
        async getIcon(iconName) {
            const response = await fetch(`${this.baseURL}/icon/${iconName}`, {
                headers: this.getHeaders(),
            });
            if (!response.ok) throw new Error("Failed to fetch icon");
            return response.blob();
        }

        // Logout
        async logout() {
            const response = await this.request("/logout", "GET");
            this.authToken = null; // Clear the token on logout
            return response;
        }
    }

    const { createApp,ref } = Vue;

    const app = createApp({
        setup() {

            const loginForm = ref({ username: '', password: '', otp: '', });
            const useOtp = ref(false);
            const loading = ref(false);
            const passwordVisible = ref(false);
            const loginUser = () => {
                loading = true;
                // Call API for login
                setTimeout(() => {
                    loading.value = false;
                    alert('Logged in successfully!');
                }, 2000); // Simulated delay
            }

            const toggleOtp = () => {
                useOtp.value = !useOtp.value;
                loginForm.password = ''; // Clear password if switching to OTP
                loginForm.otp = ''; // Clear OTP if switching to password
            }

            const togglePasswordVisibility = () => {
                passwordVisible = !passwordVisible;
                console.log(passwordVisible);

            }


            const registerForm = {
                username: '',
                full_name: '',
                email: '',
                password: '',
                invite: '',
            };
            const user = null;
            const session = null;
            const api = new APIClient();
            const register = () => {
                data = api.registerUser(registerForm);
            }
            const activeTab = 'Login';
            const TABS = ['Register', 'Login', 'Profile'];
            return {
                TABS, activeTab, user, session, api,
                registerForm,
                loginForm, useOtp, loading, passwordVisible, loginUser, toggleOtp, togglePasswordVisibility
            };
        }
    });

    app.use(PrimeVue.Config, {
        theme: {
            preset: PrimeVue.Themes.Lara,
            options: { prefix: 'p', darkModeSelector: '.app-dark', cssLayer: false, }
        }
    });
    app.use(PrimeVue.ToastService);

    app.directive('ripple', PrimeVue.Ripple);

    app.component('p-button', PrimeVue.Button);
    app.component('p-inputtext', PrimeVue.InputText);
    app.component('p-inputnumber', PrimeVue.InputNumber);
    app.component('p-tabs', PrimeVue.Tabs);
    app.component('p-tablist', PrimeVue.TabList);
    app.component('p-tab', PrimeVue.Tab);
    app.component('p-tabpanels', PrimeVue.TabPanels);
    app.component('p-tabpanel', PrimeVue.TabPanel);
    app.component('p-toast', PrimeVue.Toast);
    app.component('p-panel', PrimeVue.Panel);
    app.component('p-toggleswitch', PrimeVue.ToggleSwitch);
    app.component('p-select', PrimeVue.Select);
    app.component('p-textarea', PrimeVue.Textarea);
    app.component('p-fileupload', PrimeVue.FileUpload);

    app.mount('#app');
</script>

</html>